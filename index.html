<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catatan Harian GiatTKAIH</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- FileSaver.js for downloading files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* Custom styles for soft gradient theme and fonts */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #e0c3fc; /* Fallback color */
            background-image: linear-gradient(to top right, #e0c3fc 0%, #8ec5fc 100%);
            background-attachment: fixed; /* Ensures the gradient stays in place on scroll */
        }

        .font-pacifico {
            font-family: 'Pacifico', cursive;
        }

        .form-card {
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .habit-icon {
            width: 60px;
            height: 60px;
            object-fit: contain;
        }

        .preview-img {
            max-height: 150px;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            border: 2px dashed #ddd;
            padding: 4px;
        }

        .spinner {
            border: 2px solid rgba(0, 0, 0, 0.1);
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border-left-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-6 md:p-8 flex items-center justify-center">
    <div class="container mx-auto max-w-4xl">
        
        <!-- Header Section -->
        <header class="text-center mb-8">
            <h1 class="font-pacifico text-4xl sm:text-5xl text-white text-shadow" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.4);">
                Catatan Harian Giat<span class="text-yellow-300">TKAIH</span>
            </h1>
            <p class="text-white font-semibold mt-2 text-sm sm:text-base">Gerakan Tujuh Kebiasaan Anak Indonesia Hebat</p>
        </header>

        <!-- Main Form Container -->
        <main id="journal-form" class="form-card rounded-2xl shadow-2xl p-6 sm:p-8 space-y-8">

            <!-- Student Identity Section -->
            <section id="identitas" class="border-b-2 border-orange-200 pb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-orange-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                    Identitas Siswa
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="nama" class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                        <input type="text" id="nama" name="nama" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500" placeholder="Contoh: Budi Hartono">
                    </div>
                    <div>
                        <label for="kelas" class="block text-sm font-medium text-gray-700">Kelas</label>
                        <select id="kelas" name="kelas" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500"></select>
                    </div>
                    <div>
                        <label for="tanggal" class="block text-sm font-medium text-gray-700">Tanggal Pengisian</label>
                        <input type="date" id="tanggal" name="tanggal" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500">
                    </div>
                </div>
            </section>

            <!-- 7 Habits Section -->
            <section id="kebiasaan">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-orange-500" viewBox="0 0 20 20" fill="currentColor"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z" /></svg>
                    Tujuh Kebiasaan Harian
                </h2>
                <div class="space-y-6">
                    <!-- 1. Bangun Pagi -->
                    <div class="bg-white/60 p-4 rounded-lg shadow-md">
                        <div class="flex items-start sm:items-center flex-col sm:flex-row gap-4">
                            <img src="https://placehold.co/100x100/f9d423/333?text=☀️" alt="[Gambar Ikon Matahari]" class="habit-icon rounded-full">
                            <div class="flex-1 w-full">
                                <h3 class="font-bold text-lg text-gray-800">1. Bangun Pagi</h3>
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-2">
                                    <div>
                                        <label for="waktu-bangun" class="text-sm text-gray-600">Jam berapa kamu bangun?</label>
                                        <input type="time" id="waktu-bangun" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm">
                                    </div>
                                    <div>
                                        <label for="foto-bangun" class="text-sm text-gray-600">Upload Foto Bukti</label>
                                        <input type="file" accept="image/*" id="foto-bangun" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100" onchange="previewImage(this, 'preview-bangun')">
                                        <img id="preview-bangun" class="hidden preview-img" alt="Pratinjau Foto Bangun Pagi">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Beribadah -->
                    <div class="bg-white/60 p-4 rounded-lg shadow-md">
                        <div class="flex items-start sm:items-center flex-col sm:flex-row gap-4">
                            <img src="https://placehold.co/100x100/ff4e50/fff?text=🙏" alt="[Gambar Ikon Berdoa]" class="habit-icon rounded-full">
                            <div class="flex-1 w-full">
                                <h3 class="font-bold text-lg text-gray-800">2. Beribadah</h3>
                                <div class="mt-2 space-y-4">
                                    <div>
                                        <p class="text-sm text-gray-600 font-medium">Untuk Muslim, centang shalat yang dikerjakan:</p>
                                        <div class="flex flex-wrap gap-x-4 gap-y-2 text-sm mt-2">
                                            <label class="flex items-center"><input type="checkbox" id="shalat-subuh" class="rounded text-orange-500 focus:ring-orange-500 h-4 w-4 mr-2">Subuh</label>
                                            <label class="flex items-center"><input type="checkbox" id="shalat-dzuhur" class="rounded text-orange-500 focus:ring-orange-500 h-4 w-4 mr-2">Dzuhur</label>
                                            <label class="flex items-center"><input type="checkbox" id="shalat-ashar" class="rounded text-orange-500 focus:ring-orange-500 h-4 w-4 mr-2">Ashar</label>
                                            <label class="flex items-center"><input type="checkbox" id="shalat-maghrib" class="rounded text-orange-500 focus:ring-orange-500 h-4 w-4 mr-2">Maghrib</label>
                                            <label class="flex items-center"><input type="checkbox" id="shalat-isya" class="rounded text-orange-500 focus:ring-orange-500 h-4 w-4 mr-2">Isya</label>
                                        </div>
                                    </div>
                                    <div class="pt-2 border-t border-orange-200">
                                         <label for="ibadah-lain" class="block text-sm font-medium text-gray-700">Untuk non-Muslim, atau ibadah lainnya:</label>
                                         <input type="text" id="ibadah-lain" name="ibadah-lain" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 text-sm" placeholder="Contoh: Berdoa, ke Gereja, ke Vihara">
                                    </div>
                                    <div class="pt-2">
                                        <label for="foto-ibadah" class="text-sm text-gray-600 font-medium">Upload Foto Bukti</label>
                                        <input type="file" accept="image/*" id="foto-ibadah" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100" onchange="previewImage(this, 'preview-ibadah')">
                                        <img id="preview-ibadah" class="hidden preview-img" alt="Pratinjau Foto Beribadah">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Other Habits... -->
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- 3. Berolahraga -->
                        <div class="bg-white/60 p-4 rounded-lg shadow-md flex items-start gap-4">
                            <img src="https://placehold.co/100x100/a8e063/fff?text=🏃" alt="[Gambar Ikon Olahraga]" class="habit-icon rounded-full mt-1 hidden sm:block">
                            <div class="flex-1">
                                <h3 class="font-bold text-lg text-gray-800">3. Berolahraga</h3>
                                <label for="foto-olahraga" class="text-sm text-gray-600 mt-2 block">Upload Foto Bukti</label>
                                <input type="file" accept="image/*" id="foto-olahraga" class="mt-1 block w-full text-sm" onchange="previewImage(this, 'preview-olahraga')">
                                <img id="preview-olahraga" class="hidden preview-img" alt="Pratinjau Foto Olahraga">
                            </div>
                        </div>
                        <!-- 4. Makan Sehat & Bergizi -->
                        <div class="bg-white/60 p-4 rounded-lg shadow-md flex items-start gap-4">
                             <img src="https://placehold.co/100x100/56ab2f/fff?text=🥗" alt="[Gambar Ikon Makanan Sehat]" class="habit-icon rounded-full mt-1 hidden sm:block">
                            <div class="flex-1">
                                <h3 class="font-bold text-lg text-gray-800">4. Makan Sehat & Bergizi</h3>
                                <label for="foto-makan" class="text-sm text-gray-600 mt-2 block">Upload Foto Bukti</label>
                                <input type="file" accept="image/*" id="foto-makan" class="mt-1 block w-full text-sm" onchange="previewImage(this, 'preview-makan')">
                                <img id="preview-makan" class="hidden preview-img" alt="Pratinjau Foto Makan">
                            </div>
                        </div>
                        <!-- 5. Gemar Belajar -->
                        <div class="bg-white/60 p-4 rounded-lg shadow-md flex items-start gap-4">
                             <img src="https://placehold.co/100x100/4568dc/fff?text=📚" alt="[Gambar Ikon Buku]" class="habit-icon rounded-full mt-1 hidden sm:block">
                            <div class="flex-1">
                                <h3 class="font-bold text-lg text-gray-800">5. Gemar Belajar</h3>
                                <label for="foto-belajar" class="text-sm text-gray-600 mt-2 block">Upload Foto Bukti</label>
                                <input type="file" accept="image/*" id="foto-belajar" class="mt-1 block w-full text-sm" onchange="previewImage(this, 'preview-belajar')">
                                <img id="preview-belajar" class="hidden preview-img" alt="Pratinjau Foto Belajar">
                            </div>
                        </div>
                        <!-- 6. Bermasyarakat -->
                        <div class="bg-white/60 p-4 rounded-lg shadow-md flex items-start gap-4">
                             <img src="https://placehold.co/100x100/b06ab3/fff?text=🤝" alt="[Gambar Ikon Bermasyarakat]" class="habit-icon rounded-full mt-1 hidden sm:block">
                            <div class="flex-1">
                                <h3 class="font-bold text-lg text-gray-800">6. Bermasyarakat</h3>
                                <label for="foto-masyarakat" class="text-sm text-gray-600 mt-2 block">Upload Foto Bukti</label>
                                <input type="file" accept="image/*" id="foto-masyarakat" class="mt-1 block w-full text-sm" onchange="previewImage(this, 'preview-masyarakat')">
                                <img id="preview-masyarakat" class="hidden preview-img" alt="Pratinjau Foto Bermasyarakat">
                            </div>
                        </div>
                    </div>
                     <!-- 7. Tidur Cepat -->
                    <div class="bg-white/60 p-4 rounded-lg shadow-md">
                        <div class="flex items-start flex-col sm:flex-row gap-4">
                            <img src="https://placehold.co/100x100/2c3e50/fff?text=🌙" alt="[Gambar Ikon Bulan Sabit]" class="habit-icon rounded-full">
                            <div class="flex-1 w-full">
                                <h3 class="font-bold text-lg text-gray-800">7. Tidur Cepat</h3>
                                <p class="text-sm text-gray-600 mt-2">Pastikan kamu tidur cukup dan tidak begadang agar besok lebih semangat!</p>
                                
                                <!-- Gemini Bedtime Story Feature -->
                                <div class="mt-4 border-t border-gray-200 pt-4">
                                     <div id="story-container" class="bg-indigo-50/50 p-3 rounded-lg text-sm text-gray-700 italic min-h-[80px]">
                                        Mau dibacakan cerita sebelum tidur? Klik tombol di bawah!
                                    </div>
                                     <div class="text-left mt-3">
                                        <button id="generate-story-btn" class="bg-gradient-to-r from-indigo-500 to-slate-500 text-white font-bold py-2 px-4 rounded-full hover:from-indigo-600 hover:to-slate-600 transition duration-300 shadow-md transform hover:scale-105 flex items-center justify-center">
                                            <span id="story-btn-text">✨ Buat Cerita Pengantar Tidur (AI)</span>
                                            <div id="story-loading-spinner" class="spinner hidden ml-2"></div>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </section>
            
            <!-- Gemini AI Activity Idea Section -->
            <section id="ai-idea-generator" class="border-t-2 border-orange-200 pt-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-3">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-orange-500" viewBox="0 0 20 20" fill="currentColor"><path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 001.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" /><path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" /></svg>
                    Inspirasi Kegiatan
                </h2>
                <div id="ai-idea-container" class="bg-green-50/50 p-4 rounded-lg min-h-[100px] text-gray-700 italic">
                    Butuh ide untuk berolahraga, belajar, atau berbuat baik? Klik tombol di bawah ini!
                </div>
                 <div class="text-center mt-4">
                    <button id="generate-ideas-btn" class="w-full sm:w-auto bg-gradient-to-r from-green-500 to-teal-500 text-white font-bold py-2 px-6 rounded-full hover:from-green-600 hover:to-teal-600 transition duration-300 shadow-md transform hover:scale-105 flex items-center justify-center mx-auto">
                        <span id="idea-btn-text">✨ Minta Ide Kegiatan Seru (AI)</span>
                        <div id="idea-loading-spinner" class="spinner hidden ml-2"></div>
                    </button>
                </div>
            </section>

             <!-- Gemini AI Evaluation Section -->
            <section id="ai-evaluation" class="border-t-2 border-orange-200 pt-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-orange-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" /></svg>
                    Evaluasi Cerdas
                </h2>
                <div id="ai-feedback-container" class="bg-orange-50/50 p-4 rounded-lg min-h-[100px] text-gray-700 italic">
                    Klik tombol "Buat Evaluasi Otomatis" untuk mendapatkan masukan semangat dari AI!
                </div>
                 <div class="text-center mt-4">
                    <button id="generate-feedback-btn" class="w-full sm:w-auto bg-gradient-to-r from-blue-500 to-purple-500 text-white font-bold py-2 px-6 rounded-full hover:from-blue-600 hover:to-purple-600 transition duration-300 shadow-md transform hover:scale-105 flex items-center justify-center mx-auto">
                        <span id="btn-text">✨ Buat Evaluasi Otomatis (AI)</span>
                        <div id="loading-spinner" class="spinner hidden ml-2"></div>
                    </button>
                </div>
            </section>


            <!-- Action Buttons -->
            <section class="text-center pt-6 border-t-2 border-orange-200 mt-8">
                <button id="download-btn" class="w-full md:w-auto bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold py-3 px-8 rounded-full hover:from-orange-600 hover:to-red-600 transition duration-300 shadow-lg transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    Unduh Catatan Harian (.doc)
                </button>
            </section>
        </main>
    </div>

    <script>
        const imageCache = {};
        let aiFeedbackCache = ''; // Cache for AI generated feedback

        // Function to preview image and cache it as base64
        function previewImage(input, previewId) {
            const file = input.files[0];
            const preview = document.getElementById(previewId);
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    imageCache[previewId] = e.target.result; // Cache base64 data
                }
                reader.readAsDataURL(file);
            } else {
                preview.classList.add('hidden');
                delete imageCache[previewId];
            }
        }

        // Function to call Gemini API for Bedtime Story
        async function generateBedtimeStory() {
            const btn = document.getElementById('generate-story-btn');
            const btnText = document.getElementById('story-btn-text');
            const spinner = document.getElementById('story-loading-spinner');
            const outputContainer = document.getElementById('story-container');

            btn.disabled = true;
            btnText.textContent = 'Membuat cerita...';
            spinner.classList.remove('hidden');
            outputContainer.innerHTML = '<p>Kak Cerita sedang menyiapkan dongeng spesial untukmu...</p>';

            try {
                const nama = document.getElementById('nama').value || 'Anak Hebat';
                const kelas = document.getElementById('kelas').value;
                 if (!kelas) {
                    throw new Error("Mohon pilih kelas terlebih dahulu agar ceritanya pas.");
                }

                const systemPrompt = "Anda adalah pendongeng anak-anak yang kreatif dan lembut dari Indonesia bernama 'Kak Cerita'. Cerita Anda harus pendek (sekitar 5-7 paragraf), menenangkan, positif, dan memiliki pesan moral yang sederhana, cocok untuk usia anak.";
                const userQuery = `Tolong buatkan cerita pengantar tidur yang singkat dan menenangkan untuk ${nama}, seorang siswa ${kelas}. Tema ceritanya adalah tentang seekor karakter hewan yang belajar pentingnya salah satu dari tujuh kebiasaan baik (misalnya, bangun pagi, suka belajar, makan sehat, atau tidur cepat). Ceritanya harus positif dan memiliki pesan moral yang sederhana.`;
                
                const apiKey = ""; // API key is handled by the environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }
                
                const result = await response.json();
                const storyText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (storyText) {
                    outputContainer.innerHTML = storyText.replace(/\n/g, '<br>');
                } else {
                    throw new Error('Tidak ada cerita yang diterima dari AI.');
                }
            } catch(error) {
                console.error("Error generating bedtime story:", error);
                outputContainer.innerHTML = `<p class="text-red-600">Maaf, terjadi kesalahan: ${error.message}. Coba lagi nanti ya.</p>`;
            } finally {
                btn.disabled = false;
                btnText.textContent = '✨ Buat Cerita Pengantar Tidur (AI)';
                spinner.classList.add('hidden');
            }
        }

        // Function to call Gemini API for Activity Ideas
        async function generateActivityIdeas() {
            const btn = document.getElementById('generate-ideas-btn');
            const btnText = document.getElementById('idea-btn-text');
            const spinner = document.getElementById('idea-loading-spinner');
            const outputContainer = document.getElementById('ai-idea-container');

            btn.disabled = true;
            btnText.textContent = 'Mencari ide...';
            spinner.classList.remove('hidden');
            outputContainer.innerHTML = '<p>AI sedang mencari ide-ide seru, tunggu sebentar ya...</p>';

            try {
                const nama = document.getElementById('nama').value || 'Siswa Hebat';
                const kelas = document.getElementById('kelas').value;

                if (!kelas) {
                    throw new Error("Mohon pilih kelas terlebih dahulu.");
                }

                const systemPrompt = "Anda adalah asisten AI yang kreatif dan ramah anak bernama 'Kak Ide'. Tugas Anda adalah memberikan tiga ide kegiatan yang seru dan sesuai usia untuk siswa di Indonesia. Jawaban Anda HARUS dalam format JSON yang valid.";
                const userQuery = `Tolong berikan ide kegiatan untuk ${nama}, seorang siswa ${kelas}. Buatkan satu ide untuk 'Berolahraga', satu ide untuk 'Gemar Belajar', dan satu ide untuk 'Bermasyarakat'. Pastikan idenya sederhana, aman, dan menyenangkan.`;

                const apiKey = ""; // API key is handled by the environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "olahraga": { "type": "STRING", "description": "Satu ide kegiatan olahraga yang seru." },
                                "belajar": { "type": "STRING", "description": "Satu ide kegiatan belajar yang menarik." },
                                "masyarakat": { "type": "STRING", "description": "Satu ide kegiatan sosial/bermasyarakat yang baik." }
                            },
                            required: ["olahraga", "belajar", "masyarakat"]
                        }
                    }
                };
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                const ideas = JSON.parse(jsonText);

                if (ideas && ideas.olahraga && ideas.belajar && ideas.masyarakat) {
                    outputContainer.innerHTML = `
                        <p class="mb-2 font-semibold text-gray-800">Ini dia beberapa ide seru untukmu, ${nama}!</p>
                        <ul class="list-none space-y-2 text-left">
                            <li class="flex items-start"><span class="mr-2">🏃</span> <strong>Olahraga:</strong> ${ideas.olahraga}</li>
                            <li class="flex items-start"><span class="mr-2">📚</span> <strong>Belajar:</strong> ${ideas.belajar}</li>
                            <li class="flex items-start"><span class="mr-2">🤝</span> <strong>Bermasyarakat:</strong> ${ideas.masyarakat}</li>
                        </ul>
                    `;
                } else {
                     throw new Error('Format respons dari AI tidak sesuai.');
                }

            } catch (error) {
                console.error("Error generating activity ideas:", error);
                outputContainer.innerHTML = `<p class="text-red-600">Maaf, terjadi kesalahan: ${error.message}. Coba lagi nanti ya.</p>`;
            } finally {
                btn.disabled = false;
                btnText.textContent = '✨ Minta Ide Kegiatan Seru (AI)';
                spinner.classList.add('hidden');
            }
        }

        // Function to call Gemini API for Evaluation
        async function generateAiFeedback() {
            const btn = document.getElementById('generate-feedback-btn');
            const btnText = document.getElementById('btn-text');
            const spinner = document.getElementById('loading-spinner');
            const outputContainer = document.getElementById('ai-feedback-container');

            btn.disabled = true;
            btnText.textContent = 'Membuat evaluasi...';
            spinner.classList.remove('hidden');
            outputContainer.textContent = 'AI sedang berpikir... mohon tunggu sebentar ya!';
            
            try {
                // Collect data for the prompt
                const nama = document.getElementById('nama').value || 'Siswa Hebat';
                const kelas = document.getElementById('kelas').value;
                const waktuBangun = document.getElementById('waktu-bangun').value;
                
                const shalat = {
                    subuh: document.getElementById('shalat-subuh').checked,
                    dzuhur: document.getElementById('shalat-dzuhur').checked,
                    ashar: document.getElementById('shalat-ashar').checked,
                    maghrib: document.getElementById('shalat-maghrib').checked,
                    isya: document.getElementById('shalat-isya').checked,
                };
                
                const ibadahLain = document.getElementById('ibadah-lain').value;
                let ibadahTextForAI = '';
                if (ibadahLain) {
                    ibadahTextForAI = ibadahLain;
                } else {
                    const shalatChecked = Object.entries(shalat)
                        .filter(([key, value]) => value)
                        .map(([key]) => key.charAt(0).toUpperCase() + key.slice(1))
                        .join(', ');
                    ibadahTextForAI = shalatChecked ? `Shalat ${shalatChecked}` : 'belum diisi';
                }

                const uploadedPhotos = Object.keys(imageCache)
                    .map(key => key.replace('preview-', ''))
                    .join(', ');

                const systemPrompt = `Anda adalah seorang guru virtual yang ramah dan penyemangat bernama 'Kak Giat'. Tugas Anda adalah memberikan evaluasi singkat (3-5 kalimat), positif, dan memotivasi untuk seorang siswa di Indonesia berdasarkan laporan harian mereka. Sapa siswa dengan nama mereka. Gunakan bahasa yang ceria dan mudah dimengerti anak-anak. Fokus pada pencapaian positif mereka.`;
                
                const userQuery = `Tolong buatkan evaluasi untuk ${nama} dari kelas ${kelas}. Laporan hari ini:
- Bangun Pagi: ${waktuBangun ? `jam ${waktuBangun}` : 'belum diisi'}.
- Ibadah: ${ibadahTextForAI}.
- Telah mengunggah foto bukti untuk kegiatan: ${uploadedPhotos || 'tidak ada'}.
Berikan pujian atas apa yang sudah dilakukannya dengan baik dan berikan semangat untuk terus rajin setiap hari.`;

                const apiKey = ""; // API key is handled by the environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const result = await response.json();
                const feedbackText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (feedbackText) {
                    aiFeedbackCache = feedbackText.replace(/\n/g, '<br>'); // Store and format
                    outputContainer.innerHTML = aiFeedbackCache; // Use innerHTML for line breaks
                } else {
                    throw new Error('No content received from API.');
                }

            } catch (error) {
                console.error("Error generating AI feedback:", error);
                outputContainer.textContent = 'Maaf, terjadi kesalahan saat membuat evaluasi. Coba lagi nanti ya.';
                aiFeedbackCache = ''; // Clear cache on error
            } finally {
                btn.disabled = false;
                btnText.textContent = '✨ Buat Evaluasi Otomatis (AI)';
                spinner.classList.add('hidden');
            }
        }


        document.addEventListener('DOMContentLoaded', function() {
            // Populate class dropdown
            const kelasSelect = document.getElementById('kelas');
            const classes = [
                'PAUD', 'TK A', 'TK B',
                ...Array.from({length: 6}, (_, i) => `SD Kelas ${i + 1}`),
                ...Array.from({length: 3}, (_, i) => `SMP Kelas ${i + 7}`),
                ...Array.from({length: 3}, (_, i) => `SMA/SMK Kelas ${i + 10}`)
            ];
            classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls;
                option.textContent = cls;
                kelasSelect.appendChild(option);
            });

            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tanggal').value = today;
            
            // Add event listeners for the AI buttons
            document.getElementById('generate-story-btn').addEventListener('click', generateBedtimeStory);
            document.getElementById('generate-ideas-btn').addEventListener('click', generateActivityIdeas);
            document.getElementById('generate-feedback-btn').addEventListener('click', generateAiFeedback);


            // Handle download button click
            const downloadBtn = document.getElementById('download-btn');
            downloadBtn.addEventListener('click', function() {
                // Get all form data
                const nama = document.getElementById('nama').value || 'Belum diisi';
                const kelas = document.getElementById('kelas').value || 'Belum diisi';
                const tanggal = document.getElementById('tanggal').value || 'Belum diisi';
                const waktuBangun = document.getElementById('waktu-bangun').value || 'Tidak diisi';
                
                const shalat = {
                    subuh: document.getElementById('shalat-subuh').checked,
                    dzuhur: document.getElementById('shalat-dzuhur').checked,
                    ashar: document.getElementById('shalat-ashar').checked,
                    maghrib: document.getElementById('shalat-maghrib').checked,
                    isya: document.getElementById('shalat-isya').checked,
                };
                
                const ibadahLain = document.getElementById('ibadah-lain').value;
                let beribadahText = '';

                if (ibadahLain) {
                    beribadahText = ibadahLain;
                } else {
                    let shalatChecked = Object.entries(shalat)
                        .filter(([key, value]) => value)
                        .map(([key]) => key.charAt(0).toUpperCase() + key.slice(1))
                        .join(', ');
                    beribadahText = shalatChecked ? `Shalat: ${shalatChecked}` : 'Tidak diisi';
                }

                // Function to get image HTML
                const getImageHtml = (key, alt) => {
                    if (imageCache[key]) {
                        return `<img src="${imageCache[key]}" alt="${alt}" style="max-width: 200px; max-height: 200px; margin-top: 5px; border: 1px solid #ccc; padding: 4px; border-radius: 5px;" />`;
                    }
                    return '<p style="color: #888; font-size: 12px;"><em>Tidak ada foto</em></p>';
                };

                // Create HTML content for the Word document
                const htmlContent = `
                    <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                    <head>
                        <meta charset='utf-8'>
                        <title>Catatan Harian GiatTKAIH</title>
                        <style>
                            body { font-family: Arial, sans-serif; line-height: 1.6; }
                            .container { max-width: 800px; margin: auto; padding: 20px; }
                            h1, h2, h3 { color: #333; }
                            table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; }
                            th { background-color: #f2f2f2; }
                            .signature-table { margin-top: 50px; }
                            .signature-table td { border: none; padding: 10px; text-align: center; }
                            .signature-line { border-top: 1px solid #000; width: 200px; margin: 40px auto 0 auto; }
                            .evaluation-box { border: 1px solid #ccc; min-height: 100px; margin-top: 10px; padding: 10px; }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            <h1 style="text-align: center; color: #ff4e50;">Catatan Harian GiatTKAIH</h1>
                            <h2 style="text-align: center;">Gerakan Tujuh Kebiasaan Anak Indonesia Hebat</h2>
                            <hr>
                            
                            <h3>A. Identitas Siswa</h3>
                            <table>
                                <tr><th>Nama Lengkap</th><td>${nama}</td></tr>
                                <tr><th>Kelas</th><td>${kelas}</td></tr>
                                <tr><th>Tanggal Pengisian</th><td>${new Date(tanggal).toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</td></tr>
                            </table>

                            <h3>B. Laporan Kebiasaan Harian</h3>
                            <table>
                                <tr><th style="width: 200px;">Kebiasaan</th><th>Keterangan & Bukti</th></tr>
                                <tr>
                                    <td><strong>1. Bangun Pagi</strong></td>
                                    <td>Waktu Bangun: ${waktuBangun}<br>${getImageHtml('preview-bangun', 'Foto Bangun Pagi')}</td>
                                </tr>
                                <tr>
                                    <td><strong>2. Beribadah</strong></td>
                                    <td>Kegiatan: ${beribadahText}<br>${getImageHtml('preview-ibadah', 'Foto Beribadah')}</td>
                                </tr>
                                <tr>
                                    <td><strong>3. Berolahraga</strong></td>
                                    <td>${getImageHtml('preview-olahraga', 'Foto Olahraga')}</td>
                                </tr>
                                <tr>
                                    <td><strong>4. Makan Sehat & Bergizi</strong></td>
                                    <td>${getImageHtml('preview-makan', 'Foto Makan Sehat')}</td>
                                </tr>
                                <tr>
                                    <td><strong>5. Gemar Belajar</strong></td>
                                    <td>${getImageHtml('preview-belajar', 'Foto Belajar')}</td>
                                </tr>
                                <tr>
                                    <td><strong>6. Bermasyarakat</strong></td>
                                    <td>${getImageHtml('preview-masyarakat', 'Foto Bermasyarakat')}</td>
                                </tr>
                                <tr>
                                    <td><strong>7. Tidur Cepat</strong></td>
                                    <td><p>Terlaksana</p></td>
                                </tr>
                            </table>
                            
                            <h3>C. Evaluasi</h3>
                            <table>
                                <tr>
                                    <td style="width: 50%;">
                                        <strong>Evaluasi & Catatan Orang Tua:</strong>
                                        <div class="evaluation-box"></div>
                                    </td>
                                    <td style="width: 50%;">
                                        <strong>Evaluasi & Catatan Guru (AI):</strong>
                                        <div class="evaluation-box">${aiFeedbackCache || ''}</div>
                                    </td>
                                </tr>
                            </table>

                            <table class="signature-table">
                                <tr>
                                    <td>
                                        Mengetahui,<br>Orang Tua/Wali
                                        <div class="signature-line"></div>
                                        (...........................................)
                                    </td>
                                    <td>
                                        ....................., ${new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}
                                        <br>Guru Kelas/Wali Kelas
                                        <div class="signature-line"></div>
                                        (...........................................)
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </body>
                    </html>
                `;
                
                const blob = new Blob([htmlContent], { type: 'application/msword' });
                const fileName = `Catatan_Harian_${nama.replace(/\s/g, '_')}_${tanggal}.doc`;
                saveAs(blob, fileName);
            });
        });
    </script>
</body>
</html>

